<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="How you can reduce your costs and improve performance of external API providers by employing cloud technologies."><meta property="og:type" content="article"><meta property="og:title" content="Save Money by caching paid APIs with Amazon CloudFront"><meta property="og:url" content="https://www.codelime.blog/save-money-by-caching-paid-apis-with-cloudfront/index.html"><meta property="og:site_name" content="Code Lime"><meta property="og:description" content="How you can reduce your costs and improve performance of external API providers by employing cloud technologies."><meta property="og:locale" content="en"><meta property="og:image" content="https://www.codelime.blog/images/logo.png"><meta property="og:updated_time" content="2019-08-29T09:44:28.744Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Save Money by caching paid APIs with Amazon CloudFront"><meta name="twitter:description" content="How you can reduce your costs and improve performance of external API providers by employing cloud technologies."><meta name="twitter:image" content="https://www.codelime.blog/images/logo.png"><link rel="shortcut icon" href="../images/favicon.ico"><link rel="icon" type="image/png" href="../images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="../images/apple-touch-icon.png"><title>Save Money by caching paid APIs with Amazon CloudFront</title><link rel="stylesheet" href="../css/style.css"><link rel="stylesheet" href="../css/rtl.css"></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id="header"><a href="../index.html"><div id="logo" style="background-image:url(../images/logo.png)"></div><div id="title"><h1>Code Lime</h1></div></a><div id="nav"><ul><li class="icon"><a href="index.html#"><i class="fas fa-bars fa-2x"></i></a></li><li><a href="../index.html">Home</a></li><li><a href="../about/index.html">About</a></li><li><a href="../posts.html">Writing</a></li><li class="icon"></li> </ul></div></header><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Save Money by caching paid APIs with Amazon CloudFront</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Code Lime</span></span><div class="postdate"><time datetime="2019-08-29T08:24:12.000Z" itemprop="datePublished">2019-08-29</time></div></div></header><div class="content" itemprop="articleBody"><p>The modern developer enjoys a wide variety of third party platforms that makes his or her life easier. They can tap into already specialized functionality and curated data from the cloud, thus allowing them to focus on unique and specific business challenges.</p><p>Of course, anything comes at a price, and third party providers, be it small teams or tech giants can put a small fee for their efforts. Totally fair.</p><p>However, you may want to reduce your call expensive when you can. Or maybe you need to deliver data faster, making your application more usable. Or both. In this article I explore an option offered by <a href="https://aws.amazon.com/" target="_blank" rel="noopener">Amazon Web Services</a> that would help you achieve those requirements.</p><p><strong>Important.</strong> Whenever considering storing or caching data from an external service you must consult their data retention policies. A few will let you store it indefinitely, others not at all, while some will allow a time period. Don’t forget to read their source data attribution policy, you might have to display the data source’s name to the user.</p><h1 id="The-usecase"><a href="index.html#The-usecase" class="headerlink" title="The usecase"></a>The usecase</h1><p>Your fictional website lists some real world places of interest (could be restaurants) in a city. Best, worst, cheapest, it matters less. Once a user clicks on such a location, a more detailed view is shown. Each place, as data entity, has an id and it’s correspondent richer information. This makes it a good candidate for caching/storing it by having the id as the key.</p><p>At first I was thinking of adopting <a href="https://cloud.google.com/maps-platform/places/" target="_blank" rel="noopener">Places</a> from the Google Maps platform. However their <a href="https://cloud.google.com/maps-platform/terms/" target="_blank" rel="noopener">terms</a> about caching sound a little too strict. This led me to a Foursquare’s <a href="https://developer.foursquare.com/places-api" target="_blank" rel="noopener">Places API</a> which allows retaining their data up to 24h.</p><p><em>Note</em>: The main reasons for choosing an API are that it’s served over HTTP, retention green-light, and that it has a price. Any other provider with these criteria could have been use for article.</p><p>As a caching solution I’ll go with <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html" target="_blank" rel="noopener">Amazon CloudFront</a>. It’s easy to setup up and offers prized functionality. You can deliver, with low latency, static content and dynamic content (by proxying a HTTP server). This approach will preserve client applications code-wise agnostic to the backend, the only change being a string endpoint value.</p><p>When comparing the costs we can ignore the monthly Foursquare’s 599$ API fee for commercial usages and whatever initial calls to the <a href="https://api.foursquare.com/v2/venues/search" target="_blank" rel="noopener">search endpoint</a> to get the venue ids, as those will be the same in each case.</p><p>With this in mind, the goal is to determine the price and performance of the source and the cache technology, simplified as a contents between the endpoints:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://api.foursquare.com/v2/venues/&lt;my-venue-id&gt; </span><br><span class="line">https://&lt;distribution-id&gt;.cloudfront.net/&lt;my-venue-id&gt;</span><br></pre></td></tr></table></figure><h2 id="Benchmarking-setup"><a href="index.html#Benchmarking-setup" class="headerlink" title="Benchmarking setup"></a>Benchmarking setup</h2><p>Both the original api and the CDN will undergo the same measurements. The stress tests will try to simulate a set of users that would call the exposed RESTful API directly, as if they were on a browser or mobile app. We’ll use <a href="https://docs.k6.io" target="_blank" rel="noopener">k6</a> tool to output valuable stats and run it over the internet from my every day notebook.</p><p>Below you have a config script for <code>k6</code> and it will be used for the two cases.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// benchmark.js</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">"k6/http"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; check &#125; <span class="keyword">from</span> <span class="string">"k6"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> options = &#123;</span><br><span class="line">  vus: <span class="number">10</span>,</span><br><span class="line">  iterations: <span class="number">4000</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> url = __ENV.API_FULL_URL;</span><br><span class="line"><span class="keyword">let</span> params = &#123;</span><br><span class="line">  headers: &#123; <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip"</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> response = http.get(url, params);</span><br><span class="line"></span><br><span class="line">  check(response, &#123;</span><br><span class="line">    <span class="string">"http2 is used"</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.proto === <span class="string">"HTTP/2.0"</span>,</span><br><span class="line">    <span class="string">"status is 200"</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.status === <span class="number">200</span>,</span><br><span class="line">    <span class="string">"hit cache"</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.headers[<span class="string">"X-Cache"</span>] === <span class="string">"Hit from cloudfront"</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Due to the restrictive 500 calls daily quota on venue details endpoints on the Personal API plan, I will perform the calls on the <code>/search</code> endpoint which some coordinates that yield the same payload size, this allows almost 100k calls in a day.</p><h1 id="The-API"><a href="index.html#The-API" class="headerlink" title="The API"></a>The API</h1><h2 id="Costs"><a href="index.html#Costs" class="headerlink" title="Costs"></a>Costs</h2><p>First, let’s see how much money we’d have to pay if we used just use the API directly. Consulting their <a href="https://foursquare.com/developers/upgrade" target="_blank" rel="noopener">tier plan</a>, the cost for a fictitious total of 1 million requests, with the $0.003 per call fee, would be <strong>$3000</strong>.</p><p>Taking a look at the <a href="https://developer.foursquare.com/docs/api/troubleshooting/rate-limits" target="_blank" rel="noopener">rate limits</a> we learn about the 5000 request per hour limitation on the <code>venues/*</code> endpoints. A spike in traffic, or some batch processing, could make a caller hit that threshold. Moreover, they state they offer only 4 Queries per Second (tests say it’s actually more).</p><h2 id="Performance"><a href="index.html#Performance" class="headerlink" title="Performance"></a>Performance</h2><p>Running <code>k6</code> in terminal with the url containing your credentials as</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ k6 run -e API_FULL_URL=&quot;https://api.foursquare.com/v2/venues/search?ll=40.91,-73.01&amp;client_id=&lt;id&gt;&amp;client_secret=&lt;secret&gt;&amp;limit=38&amp;v=20190817&quot; ./benchmark.js</span><br></pre></td></tr></table></figure><p>we get the results in a detailed output, of which the two most important lines are copied in the tables:</p><table><thead><tr><th></th><th>avg</th><th>min</th><th>med</th><th>max</th><th>p(90)</th><th>p(95)</th></tr></thead><tbody><tr><td>http_req_duration</td><td>252.96ms</td><td>205.92ms</td><td>238.29ms</td><td>1.37s</td><td>282.99ms</td><td>322.97ms</td></tr></tbody></table><table><thead><tr><th></th><th>total</th><th>speed</th></tr></thead><tbody><tr><td>http_reqs</td><td>4000</td><td>39.15155/s</td></tr></tbody></table><h1 id="CloudFront"><a href="index.html#CloudFront" class="headerlink" title="CloudFront"></a>CloudFront</h1><h2 id="Costs-1"><a href="index.html#Costs-1" class="headerlink" title="Costs"></a>Costs</h2><p>For the costs, put to use the <a href="https://calculator.s3.amazonaws.com/index.html" target="_blank" rel="noopener">AWS Simply Monthly Calculator</a>. Assume you already used up your free tier privileges.</p><p>Let’s also make the supposition that on average half of the request hit the cache, and half don’t. Given 1 million request per month, each of them with a <code>Average Object Size</code> of 5 kilobytes, that would be 5 GB/Monthly at <code>Data Transfer Out</code> and another 5 at <code>Data Transfer Out to Origin</code>, if I understood correctly. Checking also <code>HTTPS</code> as the <code>Type of Requests</code>, the estimation yields a value of <strong>$1.70</strong>.</p><p>Adding to this the price of the half of million request that will not hit the CloudFront cache but the FourSquare API, which is $1500 (0.5M times $0.003), we have a total estimate of <strong>$1501.7</strong>.</p><p>On the create distribution <a href="https://console.aws.amazon.com/cloudfront/home?#create-distribution:" target="_blank" rel="noopener">page</a> there are some actions to take:</p><ul><li>we have the <code>Origin Domain Name</code> field, in our case it’s “api.foursquare.com”.</li><li>the <code>Origin path</code> is “/v2/venues”</li><li>set the <code>Origin Protocol Policy</code> to <code>Match Viewer</code> otherwise you might get some annoying 301 (Moved Permanently) status codes, redirecting you to the origin API</li><li>at <code>Object Caching</code>, select <code>Customize</code>, the granted retention period is of 24h thus put the equivalent of 86400 seconds in all the three fields</li><li>for <code>Query String Forwarding and Caching</code> I selected <code>Forward all, cache based on whitelist</code> and wrote <code>client_id</code>, <code>client_secret</code> and <code>v</code> each on a new line. This is not that important because the venue id is actually part of the route <code>venues/:id</code>/ and not a query string parameter.</li></ul><h2 id="Performance-1"><a href="index.html#Performance-1" class="headerlink" title="Performance"></a>Performance</h2><p>Using <code>k6</code> on the CloudFront endpoint this time we get the following output.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ k6 run -e API_FULL_URL=&quot;https://&lt;cloudfrontid&gt;.cloudfront.net/4acbe67af964a52044c820e3?client_id=&lt;id&gt;&amp;client_secret=&lt;secret&gt;v=20190817&quot; ./benchmark.js</span><br></pre></td></tr></table></figure><table><thead><tr><th></th><th>avg</th><th>min</th><th>med</th><th>max</th><th>p(90)</th><th>p(95)</th></tr></thead><tbody><tr><td>http_req_duration</td><td>33.28ms</td><td>29.71ms</td><td>33.1ms</td><td>160.41ms</td><td>35.07ms</td><td>36.43ms</td></tr></tbody></table><table><thead><tr><th></th><th>total</th><th>speed</th></tr></thead><tbody><tr><td>http_reqs</td><td>4000</td><td>289.580659/s</td></tr></tbody></table><h1 id="Conclusion"><a href="index.html#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Comparing $3000 versus $1500 as expenses and 269ms versus 33ms as response times we happily notice that we get 7 times the speed at half the cost. So there you have it, the numbers are too promising not to give <a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="noopener">CloudFront</a> a try.</p><p>Even if I chose to cache <a href="https://developer.foursquare.com/places-api" target="_blank" rel="noopener">Foursquare’s API</a>, this does not mean there’s anything wrong with it. On the contrary, the API is easy to get started with due to the sandbox environment, has solid documentation and provides valuable data.</p><p>However, don’t generalize and study your particular case. Quotas, rates and prices most certainly differ. For the sake of easy calculations I’ve worked with naive estimates for requests count and request size. This article is a <em>guideline</em> on how you could reduce expenses and deliver faster content and serves as a proof that it is an achievable goal.</p><h1 id="Bonus-Pre-cache-using-Lambda"><a href="index.html#Bonus-Pre-cache-using-Lambda" class="headerlink" title="Bonus? Pre-cache using Lambda"></a>Bonus? Pre-cache using Lambda</h1><p>Maybe there are better suitable solutions out there, but here’s one.</p><p>There is a possibility you need the <em>speed</em> of the CDN as soon as possible. This could make your users happier or get a higher ranking from search engines, which would pay off in the long run. Bellow I’m showcasing an imaginary scenario where you have a daily report with 1000 critical objects that should be pre-cached. The venue ids are stored in <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener">S3</a> and with the help of a <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener">Lambda function</a> you could hit CloudFront to engage caching. The function can be called by a <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/WhatIsCloudWatchEvents.html" target="_blank" rel="noopener">CloudWatch event</a> triggered every 24h and 5 minutes.</p><p>According to the <a href="https://calculator.aws/#/createCalculator" target="_blank" rel="noopener">Lambda cost calculator</a>, with the 125900 ms duration and 128 MB allocated for the script, running 30 times per moth, the cost would be $0.01. Negligible. The costs for making calls to the original API are still the same, it would be hit by an organic request eventually.</p><div class="pagination"><a class="pag-anchor" href="../microservices-3-slips-into-over-engineering-and-1-into-under-engineering/index.html"><i class="fas fa-angle-left pag-anchor">&lt older</i></a> <a class="pag-anchor" href="../react-context-vs-global-values/index.html"><i class="fas fa-angle-right pag-anchor">newer &gt</i></a></div></div></article><footer id="footer"><div class="footer-left">Copyright &copy; 2022 Randy Miller</div><div class="footer-right"><nav><ul><li><a href="../index.html">Home</a></li><li><a href="../about/index.html">About</a></li><li><a href="../posts.html">Writing</a></li><li><a href="https://twitter.com/randy_mllr">Twitter</a></li></ul></nav></div></footer></div><script>!function(t,e,a,c,n,o){e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},n=t.createElement("script"),o=t.getElementsByTagName("script")[0],n.async=1,n.src="//cdn.usefathom.com/tracker.js",n.id="fathom-script",o.parentNode.insertBefore(n,o)}(document,window,0,"fathom"),fathom("set","siteId","YFKINOVA"),fathom("trackPageview")</script></body></html>